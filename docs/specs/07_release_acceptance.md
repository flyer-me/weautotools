# 验收测试与上线阶段计划（初稿）

## 目标
定义上线前的验收条件、测试用例、回滚策略与灰度发布建议，确保核心业务（充值/消费/结算）稳定可靠。

## 验收标准（必须通过）
1. 功能正确性
   - 用户可注册/登录并访问受保护接口
   - 充值流程（下单->回调->到账）在本地/沙箱支付环境通过
   - 钱包支付在余额充足时准确扣减且生成流水
   - 幂等与并发场景通过自动化测试
2. 性能
   - 支付回调吞吐能处理预计峰值（按业务分析定义）
   - 并发扣款延迟在可接受范围内（SLA: 99% < 500ms）
3. 安全
   - OAuth2 权限与角色校验通过
   - 敏感接口审计与日志记录
4. 运维
   - 指标齐全（充值成功率、失败率、延迟、错误率等）
   - 告警阈值设置并验证通知机制（邮件/钉钉/Slack）

## 回滚策略
- 小变更：回滚应用镜像到上一个稳定版本并回退数据库变更（仅安全可逆变更）
- 数据库变更：使用 Flyway/Liquibase 的可逆 migration；若不可逆，执行修补脚本+补数据流程
- 强烈建议：上线前隔离 1）Schema 包括备份，2）数据迁移 dry-run，3）在灰度环境做完整回滚演练

## 灰度与分阶段发布
- 按商家/用户分组灰度（例如先 5% 用户）
- 使用 Feature Flag 控制计费规则的开关
- 观察关键指标 24-48 小时后逐步扩大灰度

## 测试用例（优先级）
- 单元测试：钱包服务、计费计算、流水写入
- 集成测试：充值回调、订单支付流程、退款流程
- E2E：用户注册 -> 充值 -> 下单 -> 退款 -> 对账
- 并发测试：并发 N 请求扣款与库存抢购场景
- 安全测试：权限测试、接口注入测试

## 上线检查清单（上线当天）
- 灰度配置完成并验证
- 数据库备份完成
- 监控告警已就绪并通知到位
- 回滚演练通过
- 关键接口压力测试通过

## 后续
- 制定 SLA 与 SLO
- 设立事故响应流程（IR）与联席联系人
- 定期对账任务与异常处理 SOP
